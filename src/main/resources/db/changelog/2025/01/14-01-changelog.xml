<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="add-evaluation-location-id-to-forms" author="Joao Nuno Mabjaia">
        <!-- Check if the column EVALUATION_LOCATION_ID already exists in the forms table -->
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="forms" columnName="EVALUATION_LOCATION_ID"/>
            </not>
        </preConditions>

        <!-- Add the column EVALUATION_LOCATION_ID to the forms table -->
        <addColumn tableName="forms">
            <column name="EVALUATION_LOCATION_ID" type="BIGINT(20)" defaultValue="1">
            </column>
        </addColumn>

        <!-- Define the foreign key between forms.EVALUATION_LOCATION_ID and evaluation_location.ID -->
        <addForeignKeyConstraint baseTableName="forms"
                                 baseColumnNames="EVALUATION_LOCATION_ID"
                                 referencedTableName="evaluation_location"
                                 referencedColumnNames="ID"
                                 constraintName="fk_forms_evaluation_location"/>
    </changeSet>

    <changeSet id="add-evaluation-location-id-to-form_section_questions" author="Joao Nuno Mabjaia">
        <!-- Check if the column EVALUATION_LOCATION_ID already exists in the form_section_questions table -->
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="form_section_questions" columnName="EVALUATION_LOCATION_ID"/>
            </not>
        </preConditions>

        <!-- Add the column EVALUATION_LOCATION_ID to the form_section_questions table -->
        <addColumn tableName="form_section_questions">
            <column name="EVALUATION_LOCATION_ID" type="BIGINT(20)" defaultValue="1">
            </column>
        </addColumn>

        <!-- Define the foreign key between form_section_questions.EVALUATION_LOCATION_ID and evaluation_location.ID -->
        <addForeignKeyConstraint baseTableName="form_section_questions"
                                 baseColumnNames="EVALUATION_LOCATION_ID"
                                 referencedTableName="evaluation_location"
                                 referencedColumnNames="ID"
                                 constraintName="fk_questions_evaluation_location"/>
    </changeSet>
    <changeSet id="add-unique-constraint-form-section-question" author="Joao Nuno Mabjaia">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists
                        indexName="UK_form_section_question_unique"
                        tableName="form_section_questions"/>
            </not>
        </preConditions>

        <addUniqueConstraint
                tableName="form_section_questions"
                columnNames="FORM_SECTION_ID, QUESTION_ID, RESPONSE_TYPE_ID, EVALUATION_TYPE_ID, EVALUATION_LOCATION_ID"
                constraintName="UK_form_section_question_unique"/>
    </changeSet>
    <changeSet id="insert-initial-setting-resource-directory" author="voloide">
        <insert tableName="settings">
            <column name="CREATED_AT" value="2024-05-27 14:10:12"/>
            <column name="CREATED_BY" value="49dcfc96e18644d1ae9e82dbb7e873a1"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
            <column name="UPDATED_AT" valueComputed="NULL"/>
            <column name="UPDATED_BY" valueComputed="NULL"/>
            <column name="UUID" value="e3f9d947-b2ef-4f5c-b9d1-7b09a44dvdc9"/>
            <column name="DESIGNATION" value="Mentee_ronda_removal_interval"/>
            <column name="SETTING_VALUE" value="60"/>
            <column name="DESCRIPTION" value="Muximum number of days for inactive mentee to be removed from a given mentoring cicle"/>
            <column name="SETTING_TYPE" valueComputed="NULL"/>
            <column name="ENABLED" valueNumeric="1"/>
        </insert>
    </changeSet>
    <changeSet id="add-session-summary-column" author="voloide">
        <addColumn tableName="sessions">
            <column name="SESSION_SUMMARY" type="TEXT"/>
        </addColumn>
    </changeSet>
    <changeSet id="alter-session-summary-charset" author="voloide">
        <modifyDataType
                tableName="sessions"
                columnName="SESSION_SUMMARY"
                newDataType="TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci"/>
    </changeSet>
    <changeSet id="insert-ai-session-summary-setting" author="voloide">
        <insert tableName="settings">
            <column name="UUID" value="e3f9d947-b2ef-4f5c-b9d1-7b09a44vdcx1"/>
            <column name="DESIGNATION" value="AI_SESSION_SUMMARY_GENERATION"/>
            <column name="SETTING_VALUE" value="true"/>
            <column name="DESCRIPTION" value="Enable automatic AI generation of session summaries"/>
            <column name="ENABLED" valueNumeric="1"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
            <column name="CREATED_AT" valueDate="2025-05-12T10:00:00"/>
            <column name="CREATED_BY" value="49dcfc96e18644d1ae9e82bdb7e873a1"/>
        </insert>
    </changeSet>

    <changeSet id="add-performance-risk-to-session" author="voloide">
        <sql>
            ALTER TABLE sessions
                ADD COLUMN PERFORMANCE_RISK TEXT
                CHARACTER SET utf8mb4
        COLLATE utf8mb4_unicode_ci;
        </sql>
    </changeSet>
    <changeSet id="add-ai-performance-risk-setting" author="voloide">
        <sql>
            INSERT INTO settings (UUID, DESIGNATION, SETTING_VALUE, DESCRIPTION, ENABLED, LIFE_CYCLE_STATUS, CREATED_AT, CREATED_BY)
            VALUES (
                       '3a8c1fd5-7d3f-47f2-b999-8e2c0e0b1234',
                       'AI_PERFORMANCE_RISK_EVALUATION',
                       'true',
                       'Ativa a avaliação de risco de desempenho do mentorado com IA',
                       1,
                       'ACTIVE',
                       NOW(),
                       'dbc04012-6b95-4beb-a0ec-7e5354efa8c1'
        );
    </sql>
    </changeSet>

    <changeSet id="resource_Update" author="voloide">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="resources"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM resources
            </sqlCheck>
        </preConditions>
        <sql>
            UPDATE resources
            SET resource = '[
            {
                "label": "HIV",
                "clickable": 0,
                "children": [
                    {
                        "label": "Adicionar Categoria",
                        "clickable": 1,
                        "icon": "add",
                        "program": "HIV",
                        "type": "categ"
                    }
                ]
            },
            {
                "label": "Adicionar Programa",
                "icon": "add",
                "clickable": 1,
                "type": "program"
            }
        ]'
        </sql>
    </changeSet>

    <changeSet id="create-flow-histories-table" author="JNMabjaia">
        <createTable tableName="flow_histories">
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="UUID" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="CREATED_BY" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="CREATED_AT" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="UPDATED_BY" type="VARCHAR(50)"/>
            <column name="UPDATED_AT" type="TIMESTAMP"/>

            <column name="LIFE_CYCLE_STATUS" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <!-- Campos específicos da entidade -->
            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="DESCRIPTION" type="VARCHAR(500)"/>
        </createTable>
    </changeSet>

    <changeSet id="create-flow-history-progress-statuses-table" author="JNMabjaia">
        <createTable tableName="flow_history_progress_statuses">
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="UUID" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="CREATED_BY" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="CREATED_AT" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="UPDATED_BY" type="VARCHAR(50)"/>
            <column name="UPDATED_AT" type="TIMESTAMP"/>

            <column name="LIFE_CYCLE_STATUS" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <!-- Campos específicos -->
            <column name="NAME" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="DESCRIPTION" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="create-mentee-flow-histories-table" author="JNMabjaia">
        <createTable tableName="mentee_flow_histories">
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="UUID" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="CREATED_BY" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED_AT" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="UPDATED_BY" type="VARCHAR(50)"/>
            <column name="UPDATED_AT" type="TIMESTAMP"/>
            <column name="LIFE_CYCLE_STATUS" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <!-- Campos específicos -->
            <column name="PROGRESS_STATUS_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="TUTORED_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="FLOW_HISTORY_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="RONDA_ID" type="BIGINT"/>

            <column name="CLASSIFICATION" type="double"/>

            <column name="SEQUENCE_NUMBER" type="BIGINT"/>
        </createTable>

        <!-- Foreign Keys -->
        <addForeignKeyConstraint baseTableName="mentee_flow_histories"
                                 baseColumnNames="TUTORED_ID"
                                 referencedTableName="tutoreds"
                                 referencedColumnNames="ID"
                                 constraintName="fk_mentee_flow_history_tutored"/>

        <addForeignKeyConstraint baseTableName="mentee_flow_histories"
                                 baseColumnNames="FLOW_HISTORY_ID"
                                 referencedTableName="flow_histories"
                                 referencedColumnNames="ID"
                                 constraintName="fk_mentee_flow_history_flow_history"/>

        <addForeignKeyConstraint baseTableName="mentee_flow_histories"
                                 baseColumnNames="RONDA_ID"
                                 referencedTableName="rondas"
                                 referencedColumnNames="ID"
                                 constraintName="fk_mentee_flow_ronda"/>

        <addForeignKeyConstraint baseTableName="mentee_flow_histories"
                                 baseColumnNames="PROGRESS_STATUS_ID"
                                 referencedTableName="flow_history_progress_statuses"
                                 referencedColumnNames="ID"
                                 constraintName="fk_mentee_flow_progress_status"/>
    </changeSet>



    <changeSet id="insert-initial-flow-histories" author="JNMabjaia">
        <insert tableName="flow_histories">
            <column name="UUID" value="a1111111-1111-1111-1111-111111111111"/>
            <column name="NAME" value="NOVO"/>
            <column name="DESCRIPTION" value="Registo/criação do provedor. Estado inicial se Isento à Sessão Zero = Não."/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="2025-10-03T10:00:00"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
        </insert>

        <insert tableName="flow_histories">
            <column name="UUID" value="a2222222-2222-2222-2222-222222222222"/>
            <column name="NAME" value="SESSÃO ZERO"/>
            <column name="DESCRIPTION" value="Avaliação diagnóstica inicial (“sessão zero”)."/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="2025-10-03T10:00:00"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
        </insert>

        <insert tableName="flow_histories">
            <column name="UUID" value="a3333333-3333-3333-3333-333333333333"/>
            <column name="NAME" value="RONDA / CICLO ATC"/>
            <column name="DESCRIPTION" value="Acompanhamento contínuo (ciclo de sessões). Pode pausar e retomar."/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="2025-10-03T10:00:00"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
        </insert>

        <insert tableName="flow_histories">
            <column name="UUID" value="a4444444-4444-4444-4444-444444444444"/>
            <column name="NAME" value="SESSÃO SEMESTRAL"/>
            <column name="DESCRIPTION" value="Checkpoint a cada 6 meses após uma ronda concluída."/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="2025-10-03T10:00:00"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
        </insert>
    </changeSet>

    <changeSet id="insert-initial-setting-flow-history-job-interval" author="JOAO NUNO MABJAIA">
        <insert tableName="settings">
            <column name="CREATED_AT" value="2025-11-06 14:10:12"/>
            <column name="CREATED_BY" value="49dcfc96e18644d1ae9e82dbb7e873a1"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
            <column name="UPDATED_AT" valueComputed="NULL"/>
            <column name="UPDATED_BY" valueComputed="NULL"/>
            <column name="UUID" value="e3f9d947-b2ef-4f5c-b9d1-7b09a44dtd34"/>
            <column name="DESIGNATION" value="FLOW_HISTORY_JOB_INTERVAL_MIN"/>
            <column name="SETTING_VALUE" value="5"/>
            <column name="DESCRIPTION" value="FLOW_HISTORY_JOB_INTERVAL_MIN"/>
            <column name="SETTING_TYPE" valueComputed="NULL"/>
            <column name="ENABLED" valueNumeric="1"/>
        </insert>
    </changeSet>

    <changeSet id="insert-flow-history-progress-statuses" author="JNMabjaia">
        <!-- Novo -->
        <insert tableName="flow_history_progress_statuses">
            <column name="UUID" value="11111111-1111-1111-1111-111111111111"/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="CURRENT_TIMESTAMP"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
            <column name="NAME" value="INICIO"/>
            <column name="DESCRIPTION" value="Registo/criação do provedor. Estado inicial se Isento a sessão Zero = Não"/>
        </insert>

        <!-- Sessão Zero -->
        <insert tableName="flow_history_progress_statuses">
            <column name="UUID" value="22222222-2222-2222-2222-222222222222"/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="CURRENT_TIMESTAMP"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
            <column name="NAME" value="ISENTO"/>
            <column name="DESCRIPTION" value="Sessão zero isenta"/>
        </insert>

        <insert tableName="flow_history_progress_statuses">
            <column name="UUID" value="33333333-3333-3333-3333-333333333333"/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="CURRENT_TIMESTAMP"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
            <column name="NAME" value="AGUARDA INICIO"/>
            <column name="DESCRIPTION" value="Elegível para o estágio em questão"/>
        </insert>

        <insert tableName="flow_history_progress_statuses">
            <column name="UUID" value="55555555-5555-5555-5555-555555555555"/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="CURRENT_TIMESTAMP"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
            <column name="NAME" value="TERMINADO"/>
            <column name="DESCRIPTION" value="Estágio concluído"/>
        </insert>

        <!-- Ronda / Ciclo ATC -->
        <insert tableName="flow_history_progress_statuses">
            <column name="UUID" value="66666666-6666-6666-6666-666666666666"/>
            <column name="CREATED_BY" value="system"/>
            <column name="CREATED_AT" valueDate="CURRENT_TIMESTAMP"/>
            <column name="LIFE_CYCLE_STATUS" value="ACTIVE"/>
            <column name="NAME" value="INTERROMPIDO"/>
            <column name="DESCRIPTION" value="Ronda / Ciclo ATC interrompido"/>
        </insert>
    </changeSet>

    <changeSet id="fh-add-code-col" author="voloide">
        <addColumn tableName="flow_histories">
            <column name="CODE" type="varchar(64)"/>
        </addColumn>
    </changeSet>

    <changeSet id="fhps-add-code-col" author="voloide">
        <addColumn tableName="flow_history_progress_statuses">
            <column name="CODE" type="varchar(64)"/>
        </addColumn>
    </changeSet>

    <changeSet id="fh-backfill-code" author="voloide">
        <update tableName="flow_histories">
            <column name="CODE" value="NOVO"/>
            <where>NAME IN ('NOVO')</where>
        </update>
        <update tableName="flow_histories">
            <column name="CODE" value="SESSAO_ZERO"/>
            <where>NAME IN ('SESSÃO ZERO','SESSAO ZERO')</where>
        </update>
        <update tableName="flow_histories">
            <column name="CODE" value="RONDA_CICLO"/>
            <where>NAME IN ('RONDA / CICLO ATC','RONDA / CICLO')</where>
        </update>
        <update tableName="flow_histories">
            <column name="CODE" value="SESSAO_SEMESTRAL"/>
            <where>NAME IN ('SESSÃO SEMESTRAL','SESSAO SEMESTRAL')</where>
        </update>
    </changeSet>

    <changeSet id="fhps-backfill-code" author="voloide">
        <update tableName="flow_history_progress_statuses">
            <column name="CODE" value="INICIO"/>
            <where>NAME IN ('INICIO','INÍCIO')</where>
        </update>
        <update tableName="flow_history_progress_statuses">
            <column name="CODE" value="ISENTO"/>
            <where>NAME='ISENTO'</where>
        </update>
        <update tableName="flow_history_progress_statuses">
            <column name="CODE" value="AGUARDA_INICIO"/>
            <where>NAME IN ('AGUARDA INICIO','AGUARDA INÍCIO')</where>
        </update>
        <update tableName="flow_history_progress_statuses">
            <column name="CODE" value="TERMINADO"/>
            <where>NAME='TERMINADO'</where>
        </update>
        <update tableName="flow_history_progress_statuses">
            <column name="CODE" value="INTERROMPIDO"/>
            <where>NAME='INTERROMPIDO'</where>
        </update>
    </changeSet>

    <changeSet id="fh-enforce-code-constraints" author="voloide">
        <addNotNullConstraint tableName="flow_histories" columnName="CODE" columnDataType="varchar(64)"/>
        <addUniqueConstraint tableName="flow_histories" columnNames="CODE" constraintName="UK_FLOW_HISTORIES_CODE"/>
    </changeSet>

    <changeSet id="fhs-enforce-code-constraints" author="voloide">
        <addNotNullConstraint tableName="flow_history_progress_statuses" columnName="CODE" columnDataType="varchar(64)"/>
        <addUniqueConstraint tableName="flow_history_progress_statuses" columnNames="CODE" constraintName="UK_FHPS_CODE"/>
    </changeSet>



</databaseChangeLog>
